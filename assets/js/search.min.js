(function(){'use strict';let searchIndex=null;let fuse=null;let currentLanguage=document.documentElement.lang||'en';let isLoading=false;let selectedResultIndex=-1;const searchInput=document.getElementById('site-search');const searchResults=document.getElementById('search-results');const searchContainer=document.querySelector('.search-container');if(!searchInput||!searchResults)return;const fuseOptions={keys:[{name:'title',weight:3},{name:'keywords',weight:2},{name:'description',weight:1.5},{name:'content',weight:1}],threshold:0.3,distance:100,minMatchCharLength:2,includeScore:true,includeMatches:true,ignoreLocation:true,useExtendedSearch:false};const uiStrings={ca:{placeholder:'Cerca...',noResults:'No s\'han trobat resultats per',loading:'Cercant...',resultsCount:'{count} resultat(s)',pressEnter:'Prem Enter per visitar',pressEsc:'Prem Esc per tancar'},en:{placeholder:'Search...',noResults:'No results found for',loading:'Searching...',resultsCount:'{count} result(s)',pressEnter:'Press Enter to visit',pressEsc:'Press Esc to close'}};const ui=uiStrings[currentLanguage]||uiStrings.en;async function loadSearchIndex(){if(searchIndex)return searchIndex;if(isLoading)return null;isLoading=true;try{const response=await fetch('/assets/search-index.json');if(!response.ok)throw new Error('Failed to load search index');const data=await response.json();searchIndex=data;if(searchIndex[currentLanguage]){fuse=new Fuse(searchIndex[currentLanguage],fuseOptions);}
isLoading=false;return searchIndex;}catch(error){console.error('Error loading search index:',error);isLoading=false;return null;}}
function performSearch(query){if(!query||query.length<2){hideResults();return;}
if(!fuse){showLoading();loadSearchIndex().then(()=>{if(fuse)performSearch(query);else hideResults();});return;}
const results=fuse.search(query);displayResults(results,query);}
function displayResults(results,query){selectedResultIndex=-1;if(results.length===0){searchResults.innerHTML=`<div class="search-no-results"><p>${ui.noResults}<strong>"${escapeHtml(query)}"</strong></p></div>`;showResults();return;}
const resultsHtml=results.slice(0,8).map((result,index)=>{const item=result.item;const score=(1-result.score).toFixed(2);const highlightedTitle=highlightMatches(item.title,result.matches,'title');const highlightedDesc=highlightMatches(item.description||item.content,result.matches,'description');return`<a href="${item.url}"
class="search-result-item"
data-index="${index}"
role="option"
aria-selected="false"><div class="search-result-title">${highlightedTitle}</div><div class="search-result-description">${truncate(highlightedDesc,120)}</div><div class="search-result-meta"><span class="search-result-url">${item.url}</span></div></a>`;}).join('');searchResults.innerHTML=`<div class="search-results-header"><span>${ui.resultsCount.replace('{count}',results.length)}</span></div><div class="search-results-list"role="listbox">${resultsHtml}</div><div class="search-results-footer"><kbd>↑↓</kbd>${ui.pressEnter}·<kbd>Esc</kbd>${ui.pressEsc}</div>`;showResults();}
function highlightMatches(text,matches,key){if(!matches||!text)return escapeHtml(text);const relevantMatches=matches.filter(m=>m.key===key);if(relevantMatches.length===0)return escapeHtml(text);let highlighted=text;const match=relevantMatches[0];if(match.indices&&match.indices.length>0){const sortedIndices=match.indices.sort((a,b)=>b[0]-a[0]);sortedIndices.forEach(([start,end])=>{const before=highlighted.slice(0,start);const matched=highlighted.slice(start,end+1);const after=highlighted.slice(end+1);highlighted=before+'<mark>'+escapeHtml(matched)+'</mark>'+after;});return highlighted;}
return escapeHtml(text);}
function showLoading(){searchResults.innerHTML=`<div class="search-loading"><p>${ui.loading}</p></div>`;showResults();}
function showResults(){searchResults.classList.remove('hidden');searchResults.classList.add('visible');searchInput.setAttribute('aria-expanded','true');}
function hideResults(){searchResults.classList.remove('visible');searchResults.classList.add('hidden');searchInput.setAttribute('aria-expanded','false');selectedResultIndex=-1;}
function navigateResults(direction){const resultItems=searchResults.querySelectorAll('.search-result-item');if(resultItems.length===0)return;if(selectedResultIndex>=0&&selectedResultIndex<resultItems.length){resultItems[selectedResultIndex].setAttribute('aria-selected','false');resultItems[selectedResultIndex].classList.remove('selected');}
if(direction==='down'){selectedResultIndex=Math.min(selectedResultIndex+1,resultItems.length-1);}else if(direction==='up'){selectedResultIndex=Math.max(selectedResultIndex-1,0);}
if(selectedResultIndex>=0&&selectedResultIndex<resultItems.length){resultItems[selectedResultIndex].setAttribute('aria-selected','true');resultItems[selectedResultIndex].classList.add('selected');resultItems[selectedResultIndex].scrollIntoView({block:'nearest'});}}
function selectCurrentResult(){const resultItems=searchResults.querySelectorAll('.search-result-item');if(selectedResultIndex>=0&&selectedResultIndex<resultItems.length){window.location.href=resultItems[selectedResultIndex].href;}}
function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML;}
function truncate(text,maxLength){if(!text)return'';const stripped=text.replace(/<[^>]*>/g,'');if(stripped.length<=maxLength)return text;return text.slice(0,maxLength)+'...';}
function debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args);};clearTimeout(timeout);timeout=setTimeout(later,wait);};}
searchInput.addEventListener('input',debounce(function(e){performSearch(e.target.value.trim());},300));searchInput.addEventListener('keydown',function(e){if(searchResults.classList.contains('hidden'))return;switch(e.key){case'ArrowDown':e.preventDefault();navigateResults('down');break;case'ArrowUp':e.preventDefault();navigateResults('up');break;case'Enter':e.preventDefault();selectCurrentResult();break;case'Escape':e.preventDefault();hideResults();searchInput.blur();break;}});document.addEventListener('click',function(e){if(!searchContainer.contains(e.target)){hideResults();}});searchInput.addEventListener('focus',function(){if(searchInput.value.trim().length>=2){performSearch(searchInput.value.trim());}});searchInput.setAttribute('placeholder',ui.placeholder);searchInput.setAttribute('aria-label',ui.placeholder);searchInput.addEventListener('focus',function(){if(!searchIndex){loadSearchIndex();}},{once:true});})();